name: ğŸ”§ Activate Schedule
on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  activate:
    runs-on: ubuntu-latest
    
    steps:
      # Ğ¨Ğ°Ğ³ 1: Ğ¡ĞĞĞ§ĞĞ›Ğ checkout
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      # Ğ¨Ğ°Ğ³ 2: ĞŸĞĞ¢ĞĞœ git config
      - name: âš™ï¸ Configure Git
        run: |
          echo "Configuring Git..."
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          git config --global pull.rebase true
      
      # Ğ¨Ğ°Ğ³ 3: Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ¼Ğ°Ñ€ĞºĞµÑ€Ğ° Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ğ¸
      - name: ğŸ¯ Create schedule marker
        run: |
          echo "Creating activation marker..."
          mkdir -p .github
          
          # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»-Ğ¼Ğ°Ñ€ĞºĞµÑ€
          cat > .github/schedule_marker << EOF
          # SCHEDULE ACTIVATION MARKER
          activated=true
          activated_at=$(date -u '+%Y-%m-%d %H:%M:%S UTC')
          repository=${{ github.repository }}
          trigger=${{ github.event_name }}
          run_count=1
          EOF
          
          # Ğ•ÑĞ»Ğ¸ Ñ„Ğ°Ğ¹Ğ» ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚, ÑƒĞ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑ‡ĞµÑ‚Ñ‡Ğ¸Ğº
          if [ -f .github/schedule_marker ]; then
            if grep -q "run_count" .github/schedule_marker; then
              current_count=$(grep "run_count=" .github/schedule_marker | cut -d'=' -f2)
              new_count=$((current_count + 1))
              sed -i "s/run_count=$current_count/run_count=$new_count/" .github/schedule_marker
            fi
          fi
          
          echo "âœ… Marker created/updated"
          cat .github/schedule_marker
      
      # Ğ¨Ğ°Ğ³ 4: ĞšĞ¾Ğ¼Ğ¼Ğ¸Ñ‚ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğ¹
      - name: ğŸ“¤ Commit activation
        run: |
          echo "Committing activation marker..."
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ
          if ! git diff --quiet -- .github/schedule_marker 2>/dev/null; then
            git add .github/schedule_marker
            git commit -m "ğŸ”§ Schedule activation [${{ github.event_name }}] - Run $(grep 'run_count=' .github/schedule_marker | cut -d'=' -f2)"
            
            # Pull Ğ¸ push
            git pull origin main --rebase
            git push origin main
            
            echo "âœ… Changes committed and pushed"
          else
            echo "â­ï¸ No changes to commit"
          fi
      
      # Ğ¨Ğ°Ğ³ 5: Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ
      - name: â„¹ï¸ Activation info
        run: |
          echo "=========================================="
          echo "âœ… SCHEDULE ACTIVATION COMPLETE"
          echo "=========================================="
          echo "ğŸ¯ This was run #$(grep 'run_count=' .github/schedule_marker 2>/dev/null | cut -d'=' -f2 || echo '1')"
          echo "ğŸ“… Marker created/updated: $(date)"
          echo "â° Next steps:"
          echo "   1. Run this workflow 2 more times"
          echo "   2. Wait 5 minutes between runs"
          echo "   3. Main workflow will run at 04:30 UTC"
          echo "=========================================="
